<!doctype html>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:40px;}
.card{max-width:720px;margin:auto;padding:24px;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 20px rgba(0,0,0,.06)}
.row{display:flex;gap:16px;align-items:center;}
img{max-width:100%;border-radius:12px;border:1px solid #eee}
button{padding:10px 16px;border:0;border-radius:10px;background:#111;color:#fff;cursor:pointer}
button:disabled{background:#aaa}
.pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#f3f4f6;margin:2px}
</style>
</head>
<body>
<div class="card">
<h1>Azure Vision + Speech</h1>
<p>Téléversez une image, on génère une légende, puis on la lit à voix haute.</p>
<input id="file" type="file" accept="image/*" />
<button id="analyze">Analyser</button>


<div id="preview"></div>
<h3 id="caption"></h3>
<div id="tags"></div>
<audio id="player" controls></audio>


<div style="margin-top:8px">
<button id="speak" disabled>Écouter la légende</button>
</div>
</div>


<script>
const $ = (id)=>document.getElementById(id);
const fileInput = $('file');
const btnAnalyze = $('analyze');
const btnSpeak = $('speak');
const preview = $('preview');
const caption = $('caption');
const tags = $('tags');
const player = $('player');


let lastCaption = '';


btnAnalyze.onclick = async () => {
if (!fileInput.files[0]) { alert('Choisissez une image.'); return; }
btnAnalyze.disabled = true;
caption.textContent = 'Analyse en cours…';
tags.innerHTML = '';
player.src = '';
lastCaption = '';


const imgUrl = URL.createObjectURL(fileInput.files[0]);
preview.innerHTML = `<img src="${imgUrl}" alt="aperçu"/>`;


const form = new FormData();
form.append('image', fileInput.files[0]);


const r = await fetch('/analyze', { method: 'POST', body: form });
const data = await r.json();


if (data.error) {
caption.textContent = 'Erreur: ' + data.error;
} else {
lastCaption = data.caption?.text || 'Aucune légende détectée.';
caption.textContent = lastCaption;
tags.innerHTML = (data.tags||[]).slice(0,8).map(t=>`<span class="pill">${t.name}</span>`).join('');
btnSpeak.disabled = !data.caption?.text;
}
btnAnalyze.disabled = false;
};


btnSpeak.onclick = async () => {
if (!lastCaption) return;
btnSpeak.disabled = true;
const r = await fetch('/speak', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text: lastCaption }) });
if (r.ok) {
const blob = await r.blob();
player.src = URL.createObjectURL(blob);
player.play();
}
btnSpeak.disabled = false;
};
</script>
</body>
</html>